<!DOCTYPE html>

<html>
<head>
  {% block head %}
    <title>{% block title %}{% endblock %} - V3</title>
  <!-- TODO remove external ref to d3.v4 -->
  <script src="https://d3js.org/d3.v4.js"></script>
  <script src="../static/charts.js"></script>
  <script type="text/javascript">
  // Ajax Repo List Call
  var dates = null;
  $(function() {
    $('select#project').bind('change', function() {
      $("#repo").empty()
                .prop("disabled", true)
                .append("<option>Loading Repos...</option>");
      $.getJSON($SCRIPT_ROOT + '/_return_repos', {
        key: $("#project").find(":selected").val()
      }, function(data) {
        if (data.result === ""){
          $("#repo").empty()
                    .prop("disabled", true)
                    .append("<option>No Repos Available</option>");
        }
        else {
          $('#repo').prop( "disabled", false )
                    .empty()
                    .append("<option value='' disabled selected>Select a Repo</option>")
                    .append(data.result);
        }
      });
      return false;
    });
  });
  // Ajax repo date call
  $(function() {
    $('#repo').bind('change', function() {
      $("#spinner").show();
      $.getJSON($SCRIPT_ROOT + '/_return_repo_dates', {
        key: $("#project").find(":selected").val(),
        name: $("#repo").find(":selected").text()
      }, function(data) {
        if (data.result === ""){
          //TODO error handling
          console.log("boo")
        }
        else {
          $("#previousDate").val(data.result[data.result.length-1].split(' ')[0])
              .prop("disabled",false);
          $("#currentDate").val(data.result[0].split(' ')[0])
              .prop("disabled",false);
          $("#nextbutton").prop("disabled",false);
          $("#spinner").hide();
          dates = data.result;
          commitSelector(data.result);
          getNumCommits(data.result,data.result[data.result.length-1].split(' ')[0],data.result[0].split(' ')[0])
        }
      });
      return false;
    });
  });
</script>
  {% endblock %}
</head>

<body>

<!-- Spinner to indicate ajax or analysis running -->
<div id="spinner" class="spinner" style="display:none;">
  <img id="img-spinner" src="../static/images/spinner.gif" alt="Loading"/>
</div>

<form class="form-horizontal" method="POST" enctype="multipart/form-data">
<div class="col-sm-2"></div>
<center class="col-sm-8" style="width: 900px;">

  <h3>Repository Selection</h3>

  <!-- Project and repository selection -->
  <div id="repo-select" class="form-group">
    <label for="project" class="sr-only control-label" >Select a Project: </label>
    <div class="col-sm-6">
      <select id="project" name='proj_key' class="form-control">
        <option value="" disabled selected>Select a Project</option>
        {% for project in list_of_projects %}
          <option value="{{project[0]}}">{{project[1]}}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-sm-6">
      <select id="repo" disabled="true" name='repo_name' class="form-control">
        <option value="" disabled selected>Select a project first</option>
      </select>
    </div>
  </div>

  <!-- date range selection -->
  <div id="date-select" class="form-group">
      <label for="formInput">Date Range (Default: First -> Last Commit):</label><br>
      <div class="col-sm-4">
        <div class="input-group">
          <div class="input-group-addon">Start Date:</div>
          <input type="date" class="form-control" id="previousDate" name="from_date" placeholder='YYYY-MM-DD' disabled="true">
        </div>
      </div>
      <div class="col-sm-4">
        <div class="input-group">
          <div class="input-group-addon">End Date:</div>
          <input type="date" class="form-control" id="currentDate" name="to_date" placeholder='YYYY-MM-DD' disabled="true">
        </div>
      </div>
      <div class="col-sm-4">
        <div class="input-group">
          <div class="input-group-addon">Commits:</div>
          <input type="text" class="form-control" id="commits" name="commits" placeholder='0' disabled="true">
        </div>
      </div>
      <div id="commitSelector"></div>
  </div>

  <!-- Submit Button -->
  <div id="submit-form" class="form-group">
    <button type="submit" name="submit_button" value="run_analysis" id="nextbutton" class="btn btn-lg btn-primary" role="button" disabled="true">
      Run analysis
    </button>
  </div>
</center>
<div class="col-sm-2"></div>
</form>
<script>
// Submit Button activate spinner
$("#nextbutton").click(function() {
  var $btn = $(this);
  $btn.button('loading');
  $("#spinner").show();
});

function getNumCommits(dates, date1, date2){
  var numCommits = 0;
  for (var i = 0; i < dates.length; i++){
    if (dates[i] >= date1 && dates[i] <= date2){
      numCommits++;
    }
  }
  $("#commits").val(numCommits);
}
$('#previousDate').bind('change', function() {
  getNumCommits(dates,$("#previousDate").val(),$("#currentDate").val());
});
$('#currentDate').bind('change', function() {
  getNumCommits(dates,$("#previousDate").val(),$("#currentDate").val());
});
</script>
</body>
</html>
