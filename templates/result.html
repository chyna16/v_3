<!DOCTYPE html>
<html>
<head>
    <link href='https://fonts.googleapis.com/css?family=Roboto+Slab' rel='stylesheet' type='text/css'>
    <script src = "../static/jquery-1.12.3.js"></script>
    <script src="../static/d3.min.js"></script>
    <script src="../static/bootstrap.js"></script>
    <link rel=stylesheet type=text/css href="../static/bootstrap.css">
    <link rel=stylesheet type=text/css href="../static/style.css">
    <title>Results</title>
</head>

<body>

<nav class="navbar navbar-inverse" role="navigation">
    <div class="container">
        <nav>
            <ul class="nav nav-pills pull-right">
                <li role="presentation"><a href="#">Home</a></li>
                <li role="presentation"><a onclick="goBack()">Previous</a></li>
                <li role="presentation"><a href="about.html">About</a></li>
                <li role="presentation"><a href="#">Contact</a></li>
            </ul>
        </nav>
        <a class="navbar-brand" href="/">V3</a>
    </div>
</nav>

<h1>Results for "{{repo_name}}" Repository</h1>
<h2> From {{date_after}} to {{date_before }}</h2>

<center>
    <div id="wrapperBar" style="display: block; width: 1000px; overflow-x: scroll;"></div>
</center>
<br>
<br>
<!-- <button style="float:left" class="btn btn-lg btn-default" role="button" onclick="goBack()">Go Back</button> -->
<!-- <button style="float:left" type="button" class="btn btn-info" name="wrapperBar"
        onclick="toggleGraph(this)">Bar Graph
</button> -->
<center>
<form id="filter" style="font-size:15px">
    Column: {% for key in keys|fromjson %}
                {% if key != (keys|fromjson)[0] %}
                <input type="radio" name="key" value={{ key }}> {{ key }} 
                {% endif %}
            {% endfor %} 
    &nbsp;&nbsp;&nbsp;
    From: <input type="text" name="start" style="width:40px">
    To: <input type="text" name="end" style="width:40px">
    &nbsp;&nbsp;&nbsp;
    <input type="button" value="Filter" onclick="setFilter()">
</form>
</center>
<br>
<br>
<center>
<div class="col-md-10" style="float:none">
    <table class="table">
        <thead>
        <tr>
            {% for key in keys|fromjson %}
                <th id="type" value={{ key }} onclick="chooseColumn(this)"> {{ key }} </th>
            {% endfor %}
        </tr>
        </thead>
        <tbody id="tbody"></tbody>
    </table>
</div>
</center>

<script>
    var keys = {{keys|safe}}; // an array of the data type in original order
    var json_data = {{data|safe}}; // a dictionary w/ each key (data type) holding an array
    var keys_len = keys.length; 
    var data_len = json_data.length;

    // default filter variables
    // declared outside so that value can be changed/accessed by other functions
    var filter_key = "blank"; // if left "blank" then filter will not apply
    var filter_start;
    var filter_end;
    var filtered_json;

    // called when user selects a column to filter by, and selects range
    // reads user entries and sets variables accordingly
    // if one of start/end is left empty, assigns default value
    // calls createTable
    function setFilter(filter_value) {
        filter_key = document.forms["filter"]["key"].value;
        filter_start = parseInt(document.forms["filter"]["start"].value);
            if (filter_start == null || filter_start == "") { filter_start = 0; }
        filter_end = parseInt(document.forms["filter"]["end"].value);
            if (filter_end == null || filter_end == "") { filter_end = 100000; }

        for (i=0; i<keys_len; i++) { if (filter_key == keys[i]) { createTable(); } }
    }

    // called by both createTable and createGraph
    // checks to see if the passed in value falls within the range of the filter
    // returns true if filter should be applied on said value, false if not
    function applyFilter(filter_value) {
        if (filter_value == undefined) { return false; }

        // parseInt changes user-entered number from string to int
        if (parseInt(filter_value) < filter_start || parseInt(filter_value) > filter_end) 
            { return true; }

        return false;
    }

    // parses data from dictionary using keys and fills each row.col with values
    var table = document.getElementById("tbody");
    function createTable() {
        filtered_json = [];

        json_data.forEach(function (d) {
            if (applyFilter(+d[filter_key]) != true) {
                filtered_json.push(d);
            }
        });

        d3.select("#tbody").html(""); // table is emptied before being filled

        for (i=0; i<filtered_json.length; i++) {
            // if (applyFilter(json_data[i][filter_key])) { continue; }
                // if the current value of the filter column chosen by theuser
                // falls within the filter range, then the loop skips the following 
            var row = document.createElement("tr");
            for (j=0; j<keys_len; j++) {
                var col = document.createElement("td");
                col.appendChild(document.createTextNode(filtered_json[i][keys[j]]));
                // if (j==0) { col.addEventListener('click', chooseModule); }
                row.appendChild(col);
            }
        table.appendChild(row);
        }
        createGraph(filtered_json);
    }  

 
    var chosen_key = "default"; // the default key represents all columns
    // specifies the y-axis values for the graphs to whichever column the user selects
    // calls function to create graph using the selected data
    function chooseColumn(elem) {
        chosen_key = elem.getAttribute('value');
        createGraph(filtered_json); 
    }

    // changes the display of corresponding graph to show or hide
    function toggleGraph(elem) {
        var display_status = document.getElementById(elem.getAttribute('name')).style.display;

        if (display_status == "none") 
            { document.getElementById(elem.getAttribute('name')).style.display = "block"; }
        else { document.getElementById(elem.getAttribute('name')).style.display = "none"; }
    }

    // graph dimensions
    var w;
    var width;
    var margin = {top: 20, left: 50, right: 20, bottom: 130};
    var height = 450 - margin.top - margin.bottom;
    var padding = 1;

    var color = d3.scale.ordinal().range(["#98abc5", "#8a89a6"]);

    // this is called by chooseColumn() when the user selects data for y-axis
    function createGraph(data) {
        d3.select('#wrapperBar').html("");
            // .html("") causes the wrapper to be emptied out
            // this prevents copies from being made each time function is called
            // NOTE: this apparently does not work in Safari; fix later

        if (data.length > 50) { w = data.length * 20; }
        else if (data.length < 10) { w = data.length * 100; }
        else { w = 1000; }
        width = w - margin.left - margin.right;

    ///////////////////////////// B A R  G R A P H ///////////////////////////////
        // var type = json_data[keys[0]];
        // var vlength = values.length;
        if (chosen_key == 'default') {
            // if no column was specified, the data from all value columns is used 
            var labels = d3.keys(json_data[0]).filter(function(key) 
                { return key !== keys[0] && key !== 'values'; }); 
        }
        else {
            // if a column was specified, only the data from that column is used
            var labels = d3.keys(json_data[0]).filter(function(key) 
                { return key == chosen_key; });
        }


        data.forEach(function(d, i) {
            // console.log(i);
            // console.log(+d[filter_key]);
            delete d.values;
            // if (applyFilter(+d[filter_key]) != true) {
                d.values = labels.map(function(label) {
                    // console.log(label);
                    // console.log(d[label]);
                    return {type: label, value: +d[label]};
                });
            // }
            // else { d.values = {type: "", value: ""}; }
            console.log(d.values);
            console.log(d);
        });

        // var xScale = d3.scale.ordinal()
        //         .domain(type).rangePoints([0, width - (width / values.length)]);
        // var yScale = d3.scale.linear()
        //         .domain([0, Math.max.apply(Math, values)]).range([height, 0]);

        var x0Scale = d3.scale.ordinal().rangeBands([0, width], .05);
        var x1Scale = d3.scale.ordinal();
        var yScale = d3.scale.linear().range([height, 0]);
        yScale.domain([0, d3.max(data, function(d) { 
            return d3.max(d.values, function(d) { return d.value; }); 
        })]);

        var xAxis = d3.svg.axis()
                .scale(x0Scale)
                .orient("bottom");
        // var yAxis = d3.svg.axis()
        //         .scale(yScale)
        //         .orient("left")
        //         .ticks(values.length);

        x0Scale.domain(data.map(function(d) { 
            // if (applyFilter(+d[filter_key]) != true) {
                return d[keys[0]];
            // }
        }));
        x1Scale.domain(labels).rangeBands([0, x0Scale.rangeBand()]);

        var canvas = d3.select("#wrapperBar")
            .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
            .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
        
        // if (labels.length == 1) { var cat_shift = 0; } // used for shifting of single bars
        // else { var cat_shift = x1Scale.rangeBand() / 2; } // used for shifting of grouped bars

        var category = canvas.selectAll(".category")
                .data(data)
                .enter()
            .append("g")
                .attr("class", "category")
                .attr("transform", function(d) { return "translate("+ x0Scale(d[keys[0]]) + ",0)"; });

        var bar = category.selectAll("rect")
                .data(function(d) { if (typeof d.values != 'undefined') return d.values; })
                .enter()
            .append("rect")
                .attr("height", function(d) { /*console.log(d); console.log(d.value);*/ return height - yScale(d.value); })
                .attr("width", x1Scale.rangeBand())
                .attr("x", function(d) { return x1Scale(d.type); })
                .attr("y", function(d) { return yScale(d.value); })
                .style("fill", function(d) { return color(d.type); });

        // var bar = canvas.selectAll("rect")
        //         .data(values)
        //         .enter()
        //     .append("rect")
        //         .attr("height", function (d) {
        //             return height - yScale(d);
        //         })
        //         .attr("width", width / vlength - padding)
        //         .attr("x", function (d, i) {
        //             return i * (width / vlength)
        //         })
        //         .attr("y", function (d) {
        //             return height - (height - yScale(d))
        //         });

        // canvas.selectAll("text")
        //         .data(values)
        //         .enter()
        //         .append("text")
        //         .attr("fill", "steelblue")
        //         .style("font-size", ".7em")
        //         .attr("x", function (d, i) {
        //             return i * (width / vlength) + (width / vlength) / 2
        //         })
        //         .attr("y", function (d) {
        //             return height - (height - yScale(d)) - 5
        //         })
        //         .text(function (d) {
        //             return d;
        //         })
        //         .style("text-anchor", "middle");

        canvas.append("g")
                .attr('class', 'x axis')
                .attr('transform', 'translate(0,' + (height) + ')')
                .call(xAxis)
                .selectAll("text")  
                .style("text-anchor", "end")
                .attr("dx", "-1em")
                .attr("dy", ".15em")
                .attr("transform", function(d) { return "rotate(-65)" })
                .style("font-size", ".6em")
                .attr("fill", "steelblue");
    }

    // called when user clicks "Back" button
    function goBack() {
        window.history.back();
    }

    window.onload = createTable();
    // window.onload = createGraph();

</script>

</body>
</html>
