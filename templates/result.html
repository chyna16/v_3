{% extends "layout.html" %}

{% block title %} Result {% endblock %}

{% block head %}
    <link rel="stylesheet" href="../static/jquery-ui.min.css">
    <link rel="stylesheet" href="../static/jquery.mCustomScrollbar.css" />

    <script src="../static/jquery-ui.min.js"></script>
    <script src="../static/jquery.mCustomScrollbar.concat.min.js"></script>
    <script src="../static/d3.min.js"></script>
    <script src="../static/d3-tip.js"></script>
    <script src="../static/d3.layout.cloud.js"></script>
    <script src="../static/d3-hierarchy.v0.3.min.js"></script>

    <script src="../static/interactivity.js"></script>
    <script src="../static/table.js"></script>
    <script src="../static/charts.js"></script>
{% endblock %}

{% block nav_injection %}
    <li class="dropdown" role="navigation">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Analyses<span class="caret"></span></a>
          <ul class="dropdown-menu">
            <form method="POST" enctype="multipart/form-data">
                <li><button class="btn btn-link" type="submit" name="analysis" value="metrics">Metrics</button></li>
                <li><button class="btn btn-link" type="submit" name="analysis" value="hotspots">Hotspots</button></li>
                <li><button class="btn btn-link" type="submit" name="analysis" value="coupling">Coupling</button></li>
                <li><button class="btn btn-link" type="submit" name="analysis" value="age">Age</button></li>
                <li><button class="btn btn-link" type="submit" name="analysis" value="cloud">Word Cloud</button></li>
            </form>
          </ul>
    </li>
{% endblock %}


{% block page_title %}
<p class="nav navbar-text visible-md-block visible-lg-block">Repository: {{ repo_name }}
    from
        {% if from_date != '' %} {{ from_date }}
        {% else %} beginning 
        {% endif %}
    to
        {% if to_date != '' %} {{ to_date }}
        {% else %} present
        {% endif %}
</p>
{% endblock %}


{% block content %}
<center>
<h3 class="visible-sm-block visible-xs-block">Repository: {{ repo_name }}
    from
        {% if from_date != '' %} {{ from_date }}
        {% else %} beginning 
        {% endif %}
    to
        {% if to_date != '' %} {{ to_date }}
        {% else %} present 
        {% endif %}
</h3>
</center>

<center>
    <div id="header"></div>
    <form id="filter" style="display: none"></form>
    <div id="title"></div>
</center>

<center>
<div id="container">
    <div id="wrapper">
        <div id="graph"></div>
    </div>
    <!-- <button id="hideLabels" style="display: none;"> Hide labels</button> -->

<div id="table" class="col-md-10">
    <table class="table">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
    </table>
</div>

</div>
</center>
<style>

</style>
<script>
    var keys = {{keys|safe}}; // an array of the column headers in original order
    var json_data = {{data|safe}}; // an array of objects for row of data
    var analysis_type = {{analysis|safe}}
    var repo = {{repo_name|safe}}
    // default filter variables
    // declared outside so that value can be changed/accessed by other functions
    var filtered_data = json_data; // to be used as a filtered copy of json_data
    var filter_obj = [];
    var entity_list = {};
    var temp_elem;

    var chosen_key = "default"; // the default key represents all columns
    if (analysis_type == 'metrics') { chosen_key = 'n-revs'; }
        // if the analysis is metrics, then revs column should be default

    if (analysis_type == 'coupling') {
        entity_list = {}

        json_data.forEach(function(d) {
            if (!entity_list[d.entity]) {
                entity_list[d.entity] = d.degree;
            }
            if (!entity_list[d.coupled]) {
                entity_list[d.coupled] = d.degree;
            }
        })

        // for (var key in entity_list) {
        //     console.log(key);
        // }
    }

    var help = document.getElementById("help");
    var help_desc = {
        "metrics": "View raw data for each module. Select a column to use for filtering, and enter the range (blank equals min / max respectively). Click on a column header to see data only for that column. Place your mouse over a bar to see exact value.",
        "age": "Compare lines added vs lines deleted. Select a column to use for filtering, and enter the range (blank equals min / max respectively). Click on a column header to see data only for that column. Place your mouse over a bar to see exact value.",
        "hotspots": "Hotspots indicate which modules you may need to take a closer look at. The size of the module is determined by complexity (n-lines) and the shade of red determined by effort (n-revs), proportional to the repository. Look out for the big and bright red ones. These are the ones which may need refactoring. Select a column to use for filtering, and enter the range (blank equals min / max respectively). Place your mouse over the bubbles to see module name.",
        "coupling": "Coupling shows relational data between modules based on how often they were committed together. Click on a module name to see what other modules it is coupled with and to what extent. Degree shows percentage of times that module was committed with the selected entity. Paired modules with high degree of coupling implies dependency; if one is changed, the other is likely to be affected.",
        "cloud": "View the patterns within commit messages. See which words are used the most while committing to get an understanding of things that are commonly worked on. The size of the word is proportional to frequency."
    };
    help.innerHTML = help_desc[analysis_type]; // text that will appear when ? is hovered


    // the script waits until all the html content has been loaded
    // before calling the function
    // to create the default table/graph
    document.addEventListener("DOMContentLoaded", function(event) {
        if (analysis_type == "cloud") { createGraph(json_data); }
        else {
            configureDivs();
            createTable(json_data);
            createSlider();
        }
    })
    
</script>
{% endblock %}
