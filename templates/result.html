<!DOCTYPE html>

<html>
<head>
    <link href='https://fonts.googleapis.com/css?family=Roboto+Slab' rel='stylesheet' type='text/css'>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <link rel=stylesheet type=text/css href="{{ url_for('static', filename='bootstrap.css') }}">
    <script src="{{ url_for('static', filename='bootstrap.js') }}"></script>
    <link rel=stylesheet type=text/css href="{{ url_for('static', filename='style.css') }}">
    <title>Results</title>
</head>

<body>

<nav class="navbar navbar-inverse" role="navigation">
    <div class="container">
        <nav>
            <ul class="nav nav-pills pull-right">
                <li role="presentation"><a href="#">Home</a></li>
                <li role="presentation"><a href="about.html">About</a></li>
                <li role="presentation"><a href="#">Contact</a></li>
            </ul>
        </nav>
        <a class="navbar-brand" href="/">V3</a>
    </div>
</nav>

<h1>Results for {{ repo_name }} repository</h1>

<h2> Table </h2>
<div class="col-md-8">
    <table class="table" align="center">
        <thead>
        <tr>
            {% for key in keys|fromjson %}
                <th id="type" value={{ key }} onclick="chooseColumn(this)"> {{ key }} </th>
            {% endfor %}
        </tr>
        </thead>
        <tbody id="tbody"></tbody>
    </table>
</div>
<p>
    <button class="btn btn-lg btn-default" role="button" onclick="goBack()">Go Back</button>
</p>

<button type="button" class="btn btn-info" data-target="#wrapperBar" name="wrapperBar"
        onclick="toggleGraph(this)">Bar Graph
</button>
<button type="button" class="btn btn-info" data-target="#wrapperPie" name="wrapperPie"
        onclick="toggleGraph(this)">Pie Chart
</button>
<button type="button" class="btn btn-info" data-target="#wrapperScatter" name="wrapperScatter"
        onclick="toggleGraph(this)">Scatter Plot
</button>

<form id="filter" action="form_action.asp">
    Column: <input type="text" name="key"><br>
    From: <input type="text" name="start"><br>
    To: <input type="text" name="end"><br>
    <input type="button" value="Filter" onclick="setFilter()">
</form> 

<center>
    <div id="wrapperBar" style="display: none; width: 1000px; overflow-x: scroll;"></div>
    <div id="wrapperPie" style="display: none;"></div>
    <div id="wrapperScatter" style="display: none;"></div>
</center>
<script>
    var keys = {{keys|safe}}; // an array of the data type in original order
    var json_data = {{data|safe}}; // a dictionary w/ each key (data type) holding an array
    var keys_len = keys.length;
    var data_len = json_data.length;

    var filter_key = "blank";
    var filter_start;
    var filter_end;

    function setFilter(filter_value) {
        filter_key = document.forms["filter"]["key"].value;
        filter_start = parseInt(document.forms["filter"]["start"].value);
            if (filter_start == null || filter_start == "") { filter_start = 0; }
        console.log(filter_start);
        filter_end = parseInt(document.forms["filter"]["end"].value);
            if (filter_end == null || filter_end == "") { filter_end = 100000; }
        console.log(filter_end);

        for (i=0; i<keys_len; i++) {
            if (filter_key == keys[i]) { createTable(); }
        }
    }

    function applyFilter(filter_value) {
        if (filter_value == undefined) { return 0; }

        if (parseInt(filter_value) < filter_start || parseInt(filter_value) > filter_end) { 
            return 1;
        }

        return 0;
    }


    // parses data from dictionary using keys and fills each row.col with values
    var table = document.getElementById("tbody");

    function createTable() {
        d3.select("#tbody").html("");
        console.log(filter_key);
        console.log(json_data[0][filter_key]);
        for (i=0; i<data_len; i++) {
            if (applyFilter(json_data[i][filter_key]) == 1) { continue; }

            var row = document.createElement("tr");
            for (j=0; j<keys_len; j++) {
                var col = document.createElement("td");
                col.appendChild(document.createTextNode(json_data[i][keys[j]]));
                // if (j==0) { col.addEventListener('click', chooseModule); }
                row.appendChild(col);
            }
        table.appendChild(row);
        } 
    }  


    // sets the y-axis values for the graphs to whichever column the user selects
    // calls function to create graph using the selected data
    var chosen_key = "default";

    function chooseColumn(elem) {
        chosen_key = elem.getAttribute('value');
        // var y_values = json_data[key];

        // createGraph(y_values);
        // createGraph(key);
        // console.log(y_values);
        createGraph();
    }

    // changes the display of corresponding graph to show or hide
    function toggleGraph(elem) {
        var display_status = document.getElementById(elem.getAttribute('name')).style.display;

        if (display_status == "none") {
            document.getElementById(elem.getAttribute('name')).style.display = "block";
        }
        else {
            document.getElementById(elem.getAttribute('name')).style.display = "none";
        }
    }

    // graph dimensions that do not change
    var w = 1000;
    if (data_len > 50) {
        w = data_len * 20;
    }

    var margin = {top: 20, left: 50, right: 20, bottom: 130};
    var height = 450 - margin.top - margin.bottom;
    var width = w - margin.left - margin.right;
    var padding = 1;

    var color = d3.scale.ordinal().range(["#98abc5", "#8a89a6"]);

    // this is called by chooseColumn() when the user selects data for y-axis
    // NOTE: currently, only bar graph functions displays; needs to be modified
    function createGraph() {
        d3.select("#wrapperBar").html("");
        d3.select("#wrapperPie").html("");
        d3.select("#wrapperScatter").html("");
        // .html("") causes the wrapper to be emptied out
        // this prevents copies from being made each time function is called
        // NOTE: this apparently does not work in Safari; fix later

///////////////////////////// B A R  G R A P H ///////////////////////////////
        // var type = json_data[keys[0]];
        // var vlength = values.length;
        if (chosen_key == 'default') { var labels = d3.keys(json_data[0]).filter(function(key) { return key !== json_data.keys[0]; }); 
        }
        else { 
            var labels = d3.keys(json_data[0]).filter(function(key) { return key == chosen_key; });
        }
        console.log(labels);

        json_data.forEach(function(d) {
                d.values = labels.map(function(label) {
                    return {type: label, value: +d[label]};
                });
            // console.log(d.values);
        });

        // var xScale = d3.scale.ordinal()
        //         .domain(type).rangePoints([0, width - (width / values.length)]);
        // var yScale = d3.scale.linear()
        //         .domain([0, Math.max.apply(Math, values)]).range([height, 0]);

        var x0Scale = d3.scale.ordinal().rangeRoundBands([0, width], .05);
        var x1Scale = d3.scale.ordinal();
        var yScale = d3.scale.linear().range([height, 0]);
        yScale.domain([0, d3.max(json_data, function(d) { return d3.max(d.values, function(d) { return d.value; }); })]);

        var xAxis = d3.svg.axis()
                .scale(x0Scale)
                .orient("bottom");
        // var yAxis = d3.svg.axis()
        //         .scale(yScale)
        //         .orient("left")
        //         .ticks(values.length);

        x0Scale.domain(json_data.map(function(d) { return d[keys[0]]; }));
        x1Scale.domain(labels).rangeRoundBands([0, x0Scale.rangeBand()]);

        var canvas = d3.select("#wrapperBar")
            .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
            .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
        
        var category = canvas.selectAll(".category")
                .data(json_data)
                .enter()
            .append("g")
                .attr("class", "category")
                .attr("transform", function(d) { return "translate("+ x0Scale(d[keys[0]]) + ",0)"; });

        var bar = category.selectAll("rect")
                .data(function(d) { return d.values; })
                .enter()
            .append("rect")
                .attr("height", function(d) { return height - yScale(d.value); })
                .attr("width", x1Scale.rangeBand())
                .attr("x", function(d) { return x1Scale(d.type) + 15; })
                .attr("y", function(d) { return yScale(d.value); })
                .style("fill", function(d) { return color(d.type); });

        // var bar = canvas.selectAll("rect")
        //         .data(values)
        //         .enter()
        //     .append("rect")
        //         .attr("height", function (d) {
        //             return height - yScale(d);
        //         })
        //         .attr("width", width / vlength - padding)
        //         .attr("x", function (d, i) {
        //             return i * (width / vlength)
        //         })
        //         .attr("y", function (d) {
        //             return height - (height - yScale(d))
        //         });

        // canvas.selectAll("text")
        //         .data(values)
        //         .enter()
        //         .append("text")
        //         .attr("fill", "steelblue")
        //         .style("font-size", ".7em")
        //         .attr("x", function (d, i) {
        //             return i * (width / vlength) + (width / vlength) / 2
        //         })
        //         .attr("y", function (d) {
        //             return height - (height - yScale(d)) - 5
        //         })
        //         .text(function (d) {
        //             return d;
        //         })
        //         .style("text-anchor", "middle");

        canvas.append("g")
                .attr('class', 'x axis')
                .attr('transform', 'translate(' + (width / data_len) / 2 + ',' + (height) + ')')
                .call(xAxis)
                .selectAll("text")  
                .style("text-anchor", "end")
                .attr("dx", "-1em")
                .attr("dy", ".15em")
                .attr("transform", function(d) { return "rotate(-65)" })
                .style("font-size", ".6em")
                .attr("fill", "steelblue");
    }
    // called when user clicks "Back" button
    function goBack() {
        window.history.back();
    }

    window.onload = createTable();
    window.onload = createGraph();

</script>

</body>
</html>
